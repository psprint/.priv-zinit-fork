#!/usr/bin/env zunit


@setup {
  zinit default-ice as'null' light-mode nocompile nocompletions
  ZBIN=$ZPFX/bin
  export LC_CTYPE=C
  export LANG=C
  export ZTMP=$(mktemp -qu) TMPQ=,
}

@test '(un)load-ices' {
  rm -f $ZTMP
  # @zinit-scheduler with "burst" argument executes all tasks "now"
  eval zinit load'"[[ \$TMPQ = , ]]"' atload"\"!touch \$ZTMP; TMPQ=.; TMPE=.\"" unload'"[[ \$TMPQ = . ]]"' for zdharma-continuum/null && @zinit-scheduler burst && @zinit-scheduler burst
  state=$?
  # Test if plugin effects withdrawal on unload is working
  assert "$TMPE" different_to .
  # Test if plugin is marked as unloaded
  assert "$ZINIT_REGISTERED_PLUGINS[-1]" different_to zdharma-continuum/null
  assert "$state" equals 0
  # Test if plugin is loaded
  assert "$ZTMP" is_file
}

@test 'wait-ice-with-condition' {
  rm -f $ZTMP
  # @zinit-scheduler with "burst" argument executes all tasks "now"
  eval zinit wait'"[[ -n $ZTMP ]]"' atload'"touch $ZTMP"' for zdharma-continuum/null && @zinit-scheduler burst
  state=$?
  assert $state equals 0
  assert $ZTMP is_file
}

@test 'wait-ice' {
  rm -f $ZTMP
  # @zinit-scheduler with "burst" argument executes all tasks "now"
  eval zinit wait nocd atload'"touch $ZTMP"' for zdharma-continuum/null && @zinit-scheduler burst
  state=$?
  assert "$state" equals 0
  assert "$ZTMP" is_file
}

# @test 'nnn' {
#   run zinit light-mode for jarun/nnn
#   zinit cd jarun/nnn
#   run PREFIX=$ZPFX make install; assert $state equals 0
#   local nnn="$ZPFX/bin/nnn";     assert $nnn   is_executable
#   $nnn -V;                       assert $state equals 0
# }
@test 'pipes' {
  run zinit for @pipeseroni/pipes.sh
  # zinit cd pipeseroni/pipes.sh
  run zinit run pipeseroni/pipes.sh make PREFIX=$ZPFX install; assert $state equals 0
  local pipes="$ZBIN/pipes.sh"; assert $pipes is_executable
  $pipes -v; assert $state equals 0
}
@test 'tree' {
  run zinit light-mode for Old-Man-Programmer/tree
  zinit cd Old-Man-Programmer/tree
  run make PREFIX=$ZPFX install; assert $state equals 0
  local tree="$ZBIN/tree";   assert $tree  is_executable
  $tree -v;                      assert $state equals 0
}
@test 'vim' {
  run zinit light-mode for vim/vim
  zinit cd vim/vim
  run ./configure --prefix=$ZPFX && make PREFIX=$ZPFX install
  assert $state equals 0
  local vim="$ZBIN/vim"; assert $vim is_executable
  $vim --version; assert $state equals 0
}
# @test 'zsh_bin' {
#   run zinit as'null' sbin'bin/zsh' for @romkatv/zsh-bin
#   assert $state equals 0
#   local zsh_static="$ZPFX/bin/zsh"
#   assert "$zsh_static" is_executable
#   $zsh_static --help
#   assert $state equals 0
# }

# vim:ft=zsh:sw=2:sts=2:et:foldmarker=@test,}:foldmethod=marker
